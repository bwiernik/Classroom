# (PART) Module 02 {-}

# Plotting with **ggplot2**  {-}

Set up the workspace:

```{r setup}
# Load required packages
library(tidyverse) # loads ggplot2 and other tidyverse packages
library(gapminder) # loads the gapminder dataset

# Set a default figure size
knitr::opts_chunk$set(fig.width = 5, fig.height = 4, fig.align = "center")
```

## Learning Objectives

By the end of this lesson, you will be able to:

- Have a sense of why we're learning **ggplot2**
- Understand the importance of statistical graphics in communicating information
- Identify the components of the grammar of graphics underlying **ggplot2**
- Use different geometric objects and aesthetics to explore various plot types

## Resources

Here are some good walkthroughs that introduce **ggplot2**:

- [r4ds: data-vis](http://r4ds.had.co.nz/data-visualisation.html) chapter.
- The [ggplot2 book](http://webcat2.library.ubc.ca/vwebv/holdingsInfo?bibId=8489511), Chapter 2
- [Jenny Bryant's **ggplot2** tutorial](https://github.com/jennybc/ggplot2-tutorial)
- [Andrew Heiss's data visualization course](https://datavizs21.classes.andrewheiss.com/)

Here are some good resource to use as a reference:

- [**ggplot2** cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf)
- [R Graphics Cookbook](http://www.cookbook-r.com/Graphs/)

# Plotting in R

TL;DR: We're using **ggplot2** in progdata.

R has several frameworks for building graphics.
One of the earliest advantages when R (and its predecessor S) were introduced in the 1980s was its professional plotting capabilities.

However, the "base R" plotting methods, mostly accessed using the `plot()` function, can be involved, and requires a lot of "drawing by hand". 

That said, for simple "quick looks" at data, base R plots can be useful:

```{r}
plot(airquality[,1:4])
```

The most widely used modern plotting tool in R is **ggplot2**, 
which provides a very powerful framework for making plots. 
It has a theoretical underpinning, too, based on the Grammar of Graphics, first described by Leland Wilkinson in his 
["Grammar of Graphics" book](http://resolve.library.ubc.ca/cgi-bin/catsearch?bid=5507286). 
With **ggplot2**, you can make a great many type of plots with minimal code. 
It's been a hit in and outside of the R community.

  - A big advantage of **ggplot2** is that many people have written extensions for
    it, such as [**ggdist**](https://mjskay.github.io/ggdist/articles/slabinterval.html) (for plotting distributions and intervals),
    [**gganimate**](https://gganimate.com/) (for animations and GIFs),
    [**plotly**](https://plot.ly/) for interactive graphs, and
    [**see**](https://easystats.github.io/see/) (ready-built visualizations for many models).


## Just Plot It

The human visual cortex is a powerful thing. 
If you're wanting to point someone's attention to a bunch of numbers, 
you probably won't get any "aha" moments by displaying a large table [like this](https://i.stack.imgur.com/2JdLt.png), 
either in a report or (especially!) a presentation. 

Make a plot to communicate your message!

Florence Nightingale was a pioneer in many fields (e.g., nursing, sanitation, public health, statistics). Her contributions to statistics (a field generally prohibited to women in her era) were centered around communicating data using visualization.

![Picture of Florence Nightingale](img/florence_nightingale.jpg)

During the Crimean Wars, she convinced the British military to implement a variety of sanitation measures through effective and innovative data visualization.

![Florence Nightingale's Rose Diagram](img/rose_diagram.jpg)

If you really feel the need to tell your audience every number exactly, consider putting your table in an appendix.
Because chances are, the reader doesn't care about the exact numeric values. Or, perhaps you just want to point out one or a few numbers, in which case you can put that number directly on a plot.

# The Grammar of Graphics

You can think of the grammar of graphics as a systematic approach for describing the components of a graph. It breaks down "classic" plots into individual components that let us make more complex, nuanced, and informative graphic through novel combinations. 

The grammar of graphics has seven components (the ones in bold are required 
explicitly **ggplot2**):

- **Data**
  - The data that you're feeding into a plot.
- **Aesthetic mappings**
  - How are variables (columns) from your data connect to a visual dimension?
  - Horizontal (x) positioning, vertical (y) positioning, size, color, shape, etc.
  - These visual dimensions are called "aesthetics"
- **Geometric objects**
  - What are the objects that are actually drawn on the plot? 
  - A point, a line, a bar, a histogram, a density, etc. 
- Scales
  - How is a variable mapped to its aesthetic?
  - Will it be mapped linearly? On a log scale? Something else?
  - This includes things like the color scale
    - e.g., c(control, treatment_1, treatment_2) -> c("blue", "green", "red")
- Statistical transformations
  - Whether and how the data are combined/transformed before being plotted
  - e.g., in a bar chart, data are transformed into their frequencies; 
          in a box-plot, data are transformed to a five-number summary.
- Coordinate system
  - This is a specification of how the position aesthetics (x and y) are depicted on the plot. 
    For example, rectangular/Cartesian, or polar coordinates.
- Facet
  - This is a specification of data variables that partition the data into 
    smaller "sub plots", or panels. 


## Example: Scatterplot grammar

For example, consider the following plot from the `gapminder` data set. 
For now, don't focus on the code, just the graph itself.

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp) + 
  geom_point(alpha = 0.1) +
  scale_x_continuous(
    name = "GDP per capita", 
    trans = "log10",
    labels = scales::dollar_format()
  ) +
  theme_bw() +
  scale_y_continuous("Life expectancy")
```

This scatterplot has the following components of the grammar of graphics. 

| Grammar Component     | Specification |
|-----------------------|---------------|
| **data**              | `gapminder`   |
| **aesthetic mapping** | **x**: `gdpPercap`, **y:** `lifeExp` |
| **geometric object**  | points  |
| scale                 | x: log10, y: linear |
| statistical transform | none  |
| coordinate system     | rectangular  |
| faceting              | none  |

Note that `x` and `y` aesthetics are required for scatterplots (or "point" geometric objects). 
Each geometric object has its own required set of aesthetics. 


## Activity: Bar chart grammar

Consider the following plot. 
Don't concern yourself with the code at this point.

```{r, fig.width = 5, fig.height = 2}
gapminder |> 
  filter(year == 2007) |> 
  mutate(continent = fct_infreq(continent)) |> 
  ggplot() +
  aes(x = continent, fill = continent) +
  geom_bar() +
  guides(fill = "none") +
  theme_bw()
```

Fill in the seven grammar components for this plot.

| Grammar Component     | Specification |
|-----------------------|---------------|
| **data**              | `gapminder` |
| **aesthetic mapping** | FILL_THIS_IN |
| **geometric object**  | FILL_THIS_IN |
| scale                 | FILL_THIS_IN |
| statistical transform | FILL_THIS_IN |
| coordinate system     | FILL_THIS_IN |
| facetting             | FILL_THIS_IN |


# Working with **ggplot2**

First, the **ggplot2** package comes with the **tidyverse** meta-package. 
You can just load **tidyverse**, and it will also load **ggplot2**.

Let's use the above scatterplot as an example to see how to use the `ggplot()` function.

First, we will pass one argument to `ggplot()` function itself:
  - `data`: the data frame containing your plotting data
  
```{r}
ggplot(gapminder)
```
  
After this, we **add** additional functions as **layers** to add features to the plot and control their appearance. The first thing we will add is `aes()`. The `aes()` function tells R to look in the `data` for variable names to *map* them to different *aesthetic features*, such as x-position, y-position, or color.

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp)
```

Next, we want to add some **geometric shapes** to the plot. 
These use functions with the form `geom_SOMETHING()`.
Different plot shapes (`geom_SOMETHING`) accept different `aes()` arguments.
These are listed in the help file for the geom function: 
`?geom_point`, `?geom_line`, etc.

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp) + 
  geom_point()
```

You can control aesthetics using constants or variables from outside `data` by specifying them outside of `aes()`. 
For example, to make all of the shapes of plot blue, you can add: `color = "blue"`.

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp) + 
  geom_point(color = "blue")
```

There's a bit of overplotting (overlapping symbols), so let's also make the points semi-transparent.
This is controlled using the `alpha` argument 
(you need `1/alpha` points overlaid to achieve a solid point).

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp) + 
  geom_point(color = "blue", alpha = .1)
```

For now, that's the only `geom` that we want to add. 
Now, let's specify a scale transformation, because the plot would really benefit if the x-axis is on a logarithmic 
scale. 
These functions take the form `scale_AESTHETIC_TYPE()`. 

As usual, you can tweak this layer, too, using this function's arguments. 
In this example, we're re-naming the x-axis (the `name` argument), 
transform the values (the `trans` argument), 
and changing the labels to have a dollar format (the `labels` argument).

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp) + 
  geom_point(color = "blue", alpha = .1) +
  scale_x_continuous(
    name = "GDP per capita", 
    trans = "log10", 
    labels = scales::dollar_format()
  )
```

I'm tired of seeing the ugly default gray background, so I'll add a `theme()` 
layer. 
I like `theme_bw()` (you can tweak themes later, too!). 
Then, I'll re-label the y-axis using the `ylab()` function. 
Et voilà!

```{r}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp) + 
  geom_point(color = "blue", alpha = .1) +
  scale_x_continuous(
    name = "GDP per capita", 
    trans = "log10", 
    labels = scales::dollar_format()
  ) +
  theme_bw() +
  ylab("Life expectancy")
```

# Activity: Build some plots!

## Make a Line Chart

The following code makes a data frame called `mauna` that contains time series data of CO$_2$ concentrations collected monthly at the Mauna Loa vocanic observation station.

Execute this code to store the data in `mauna`:

```{r}
(mauna <- tsibble::as_tsibble(co2) |> 
   rename(month = index, conc = value))
```

Produce a line chart showing the concentration over time. 
Specifically, the plot should have the following grammar components:

| Grammar Component     | Specification |
|-----------------------|---------------|
| __data__              | `mauna` |
| __aesthetic mapping__ | x: month, y: conc |
| __geometric object__  | lines |
| scale                 | yearmonth |
| statistical transform | none |
| coordinate system     | rectangular |
| faceting              | none |

Fill in the blanks to obtain the plot:

```{r, fig.width = 5, fig.height = 2, eval = FALSE}
ggplot(FILL_THIS_IN) +
  aes(FILL_THIS_IN, FILL_THIS_IN)
  FILL_THIS_IN() + 
  tsibble::scale_x_yearmonth()
```

## Make a Scatterplot

Use the `palmerpenguins::penguins` data to make a scatterplot with the following specifications:

| Grammar Component     | Specification |
|-----------------------|---------------|
| __data__              | `palmerpenguins::penguins` |
| __aesthetic mapping__ | x: body_mass_g, y: bill_depth_mm |
| __geometric object__  | points, smoothed lines |
| scale                 | linear |
| statistical transform | none |
| coordinate system     | rectangular |
| faceting              | none |


```{r, fig.width = 5, fig.height = 2, eval = FALSE}
ggplot(FILL_THIS_IN) +
  aes(FILL_THIS_IN, FILL_THIS_IN)
  FILL_THIS_IN() + 
  geom_smooth()
```

You can control aesthetics for individual layers by adding an `aes()` inside the layer function, like this:

```
geom_point(aes(color = COLOR_VARIABLE))
````

Modify your code above so that the points (but not the smooth line) have their `color` mapped to `species`:

```{r, fig.width = 5, fig.height = 2, eval = FALSE}
ggplot(FILL_THIS_IN) +
  aes(FILL_THIS_IN, FILL_THIS_IN)
  FILL_THIS_IN() + 
  geom_smooth()
```

Now, instead, map `color` in the global `aes()` call for the plot.
What happens?

```{r, fig.width = 5, fig.height = 2, eval = FALSE}
ggplot(FILL_THIS_IN) +
  aes(FILL_THIS_IN, FILL_THIS_IN)
  FILL_THIS_IN() + 
  geom_smooth()
```

Things to keep in mind:

- Aesthetics mapped outside of a specific layer apply **globally**
- Aesthetics mapped inside a `geom` layer apply only to that layer.
- If the same aesthetic appears both globally and in a layer, the layer-specific one wins


## Assigning a **ggplot2** object and adding to it

You can store the output of the plot in a variable. 
Assign the `mauan` plot above to a variable named `p`, 
then add a layer to `p` that adds a dark green smoothed line to the plot.

```{r, fig.width = 5, fig.height = 2, eval = FALSE}
FILL_THIS_IN

p +
  FILL_THIS_IN()
```


## Fix Me!

What's wrong with the following code? Fix it.

```{r, fig.width = 5, fig.height = 2, eval = FALSE}
ggplot(gapminder) +
  geom_point(x = gdpPercap, y = lifeExp, alpha = 0.1)
```

What's wrong with this code? Fix it.

```{r, fig.width = 5, fig.height = 2, eval = FALSE}
ggplot(cars) +
  geom_point(aes(x = speed, y = dist, color = "blue"))
```

# Example *geoms* and Plots

## Bar chart

```{r}
theme_set(theme_classic())

ggplot(penguins) +
  aes(x = species) +
  geom_bar()
```

## Stacked bar chart

```{r}
ggplot(penguins) +
  aes(y = island,
      color = fct_rev(species),
      fill = fct_rev(species),
      label = fct_rev(species)) +
  stat_count(orientation = "y") +
  guides(color = guide_none(),
         fill = guide_none()) +
  ylab(NULL) +
  stat_count(geom = "label",
             color = "white")
```

## Pie chart

```{r}
ggplot(penguins) +
  aes(x = factor(1),
      fill = species,
      label = species) +
  geom_bar(width = 1) +
  stat_count(geom = "text",
             size = 5,
             color = "white",
             position = position_stack(vjust = .5)
  ) +
  guides(y = guide_none(),
         x = guide_none(),
         fill = guide_none()) +
  xlab(NULL) +
  ylab(NULL) +
  coord_polar(theta = "y") +
  theme(axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank())
```

## Histogram

```{r}
ggplot(penguins) +
  aes(x = bill_length_mm) +
  geom_histogram(binwidth = 1)
```

## Density

```{r}
ggplot(penguins) +
  aes(x = bill_length_mm) +
  geom_density()
```

## Dot plot

```{r}
ggplot(penguins) +
  aes(x = bill_length_mm) +
  geom_dotplot(binwidth = 1,
               dotsize = .5) +
  guides(y = guide_none())
```

## Scatterplots

```{r}
# Scatterplot 1
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm) +
  geom_point()

# Scatterplot 2
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species,
      shape = species) +
  geom_point()

# Scatterplot 3
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species,
      shape = sex,
      size = body_mass_g) +
  geom_point()
```

## More scatterplots

```{r}
# Scatterplot 4
ggplot(round(alr4::Heights)) +
  aes(x = mheight,
      y = dheight) +
  geom_point()

# Scatterplot 5
ggplot(round(alr4::Heights)) +
  aes(x = mheight,
      y = dheight) +
  geom_jitter(height = .3, width = .3)
```

## Building complex plots

```{r}
# Scatterplot 6
ggplot(penguins) +
  aes(x = species,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_point()

# Scatterplot 7
ggplot(penguins) +
  aes(x = species,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_jitter(height = 0,
              width = .4)

# Scatterplot 8
ggplot(penguins) +
  aes(x = species,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_jitter(height = 0,
              width = .4) +
  geom_boxplot(color = "black",
               alpha = .5)

# Raincloud plot
ggplot(na.omit(penguins)) +
  aes(y = species,
      x = flipper_length_mm,
      fill = species,
      color = species) +
  geom_jitter(height = .15) +
  geom_boxplot(color = "black",
               alpha = .5,
               width = .1,
               size = .5) +
  ggdist::stat_slab(height = .3,
                    color = "black",
                    size = .2,
                    alpha = .5,
                    position = position_nudge(y = .2))
```

## Scatterplots for change

```{r}
df <- data.frame(
  id = 1:30,
  before = rnorm(30),
  after = rnorm(30))
df <- tidyr::pivot_longer(
  df,
  -id,
  names_to = "time",
  values_to = "score")
ggplot(df) +
  aes(x = time,
      y = score,
      group = id) +
  geom_point() +
  geom_line()
```

## Comparing distributions

```{r}
df <- data.frame(
  g = c(rep("a", times = 100),
        rep("b", times = 100),
        rep("c", times = 100),
        rep("d", times = 100),
        rep("e", times = 100)),
  z = c(rnorm(100, mean = 0, sd = 1),
        rnorm(100, mean = 1, sd = 2),
        rnorm(100, mean = 2, sd = 3),
        rnorm(100, mean = 3, sd = 4),
        rnorm(100, mean = 4, sd = 5))
)

# Overlapping densities
ggplot(df) +
  aes(x = z,
      group = g,
      fill = g) +
  geom_density(size = .2,
               alpha = .5)

# Ridge plot
ggplot(df) +
  aes(x = z,
      y = g,
      fill = g) +
  ggridges::geom_density_ridges(
    size = .2,
    alpha = .5,
    scale = 4
  )
```

## Scatterplot matrix

```{r}
penguins_focal <- penguins[, c("species",
                               "bill_length_mm",
                               "flipper_length_mm",
                               "sex")]
pairs(penguins_focal)

GGally::ggpairs(
  penguins_focal,
  mapping = aes(color = species, alpha = .5),
  lower = list(
    continuous = "smooth_loess",
    combo = "facethist",
    discrete = "facetbar",
    na = "na"
  )
) + theme_classic()
```

## Smoothers and Exploratory Data Analysis

```{r}
# Smoother 1
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_point() +
  geom_smooth(color = "black",
              fill = "black")

# Smoother 2
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_point() +
  geom_smooth(color = "black",
              fill = "black") +
  geom_smooth(method = "lm",
              color = "orange",
              fill = "orange")

# Smoother 3
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_point() +
  geom_smooth()

# Smoother 4
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_point() +
  geom_smooth() +
  geom_smooth(method = "lm",
              color = "black",
              linetype = "dashed")

# Smoother 5
ggplot(penguins) +
  aes(x = bill_length_mm,
      y = flipper_length_mm,
      fill = species,
      color = species) +
  geom_point() +
  geom_smooth(method = "lm",
              linetype = "dashed") +
  geom_smooth(color = "black",
              fill = "black",
              alpha = .2) +
  geom_smooth(method = "lm",
              color = "orange",
              fill = "orange",
              alpha = .2)

# Smoother 6
ggplot(penguins) +
  aes(x = flipper_length_mm,
      y = bill_length_mm,
      color = species,
      fill = species,
      shape = species,
      linetype = species) +
  geom_point(alpha = .7) +
  geom_smooth() +
  theme_bw() +
  theme(legend.position = "bottom")
```
